<html>
  <head>
    <meta charset="utf-8" />
    <title>Date Picker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.0.2/react.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.0.2/react-dom.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.23/browser.min.js"></script>
    <link rel="stylesheet" type="text/css" href="style.css">
  </head>
  <body>
    <div id="content"></div>
    <script type="text/babel">

      var monthNames = ["January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"
      ];
      var monthNamesShort = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul',
        'Aug', 'Sep', 'Oct', 'Nov', 'Dec'
      ];

      var dayNamesShort = ['Su','Mo','Tu','We','Th','Fr','Sa'];

      function daysInMonth(month, year) {
        return new Date(Date.UTC(year, month + 1, 0)).getDate();
      }

      function range(n){
        return Array.apply(null, Array(n)).map(function (_, i) {return i;});
      }

      var DateSelector = React.createClass({
        getInitialState: function() {
          var today = new Date();
          return {
            day: today.getDate(),
            month: today.getMonth(),
            year: today.getFullYear(),
            viewMonth: today.getMonth(),
            viewYear: today.getFullYear(),
            selectedView: "day"
          };
        },

        setSelectedView: function(view) {
          this.setState({"selectedView": view});
        },

        setSelectedDate: function(day, month, year) {
          this.setState({"day": day, "month": month, "year": year, "viewMonth": month, "viewYear": year})
        },

        setSelectedDay: function(day) {
          this.setState({"day": day})
        },

        setSelectedMonth: function(month) {
          this.setState({"month": month})
        },

        setSelectedYear: function(year) {
          this.setState({"year": year})
        },

        setViewMonth: function(month) {
          this.setState({"viewMonth": month})
        },

        setViewYear: function(year) {
          this.setState({"viewYear": year})
        },

        render: function() {
          return (
            <div className="dateSelector">
              {
                this.state.selectedView === "day" ?
                  <DaySelector
                    setSelectedDate={this.setSelectedDate}
                    day={this.state.day}
                    month={this.state.month}
                    year={this.state.year}
                    viewMonth={this.state.viewMonth}
                    viewYear={this.state.viewYear}
                    setViewMonth={this.setViewMonth}
                    setViewYear={this.setViewYear}
                    setSelectedView={this.setSelectedView}
                  /> : null
              }
              {
                this.state.selectedView === "month" ?
                  <ViewMonthSelector
                    month={this.state.month}
                    viewYear={this.state.viewYear}
                    selectedYear={this.state.year}
                    setViewMonth={this.setViewMonth}
                    setViewYear={this.setViewYear}
                    setSelectedView={this.setSelectedView}
                  /> : null
              }
              {
                this.state.selectedView === "year" ?
                  <ViewYearSelector 
                    year={this.state.year}
                    setViewYear={this.setViewYear}
                    setSelectedView={this.setSelectedView}
                  /> : null
              }
            </div>
          );
        }
      });

      var DayLabel = React.createClass({
        setSelectedDate: function() {
          this.props.setSelectedDate(this.props.day, this.props.month, this.props.year);
        },

        render: function() {
          var className = "dayCell";
          if (this.props.selected) className += " dayCellSelected"
          if (this.props.otherMonth) className += " dayCellOtherMonth"
          return (
            <div className="cell"><div onClick={this.setSelectedDate} className={className}>{this.props.day}</div></div>
          )
        }
      })

      var MonthSwitcher = React.createClass({
        updateViewMonthAndYear: function(monthDate) {
          this.props.setViewMonth(monthDate.getMonth());
          this.props.setViewYear(monthDate.getFullYear());
        },

        switchToPreviousMonth: function() {
          var previousMonthDate = new Date(this.props.viewYear, this.props.viewMonth - 1, 1);
          this.updateViewMonthAndYear(previousMonthDate);
        },

        switchToNextMonth: function() {
          var nextMonthDate = new Date(this.props.viewYear, this.props.viewMonth + 1, 1);
          this.updateViewMonthAndYear(nextMonthDate);
        },

        handleMonthClick: function(){
          this.props.setSelectedView("month");
        },

        handleYearClick: function(){
          this.props.setSelectedView("year");
        },

        render: function() {
          return (
            <div className="switcherContainer">
              <div onClick={this.switchToPreviousMonth} className="leftArrow"> &larr; </div>
              <div onClick={this.switchToNextMonth} className="rightArrow"> &rarr; </div>
              <div className="switcherCentralContainer">
                <span onClick={this.handleMonthClick} className="switcherButton">{monthNames[this.props.viewMonth]}</span>&nbsp;
                <span onClick={this.handleYearClick} className="switcherButton">{this.props.viewYear}</span>
              </div>
            </div>
          )
        }
      });

      var DaySelector = React.createClass({
        render: function() {
          var firstDayOfMonth = new Date(Date.UTC(this.props.viewYear, this.props.viewMonth, 1));
          var lastDayOfMonth = new Date(Date.UTC(this.props.viewYear, this.props.viewMonth + 1, 0));
          var lastDayOfPreviousMonth = new Date(Date.UTC(this.props.viewYear, this.props.viewMonth, 0))
          var daysInPreviousMonth = lastDayOfPreviousMonth.getDate();
          var previousMonth = lastDayOfPreviousMonth.getMonth()
          var previousYear = lastDayOfPreviousMonth.getFullYear()

          var firstDayOfNextMonth = new Date(Date.UTC(this.props.viewYear, this.props.viewMonth + 1, 1))
          var nextMonth = firstDayOfNextMonth.getMonth()
          var nextYear = firstDayOfNextMonth.getFullYear()

          var day, selected;
          var days = []
          for (var i=0; i<firstDayOfMonth.getDay(); i++){
            day = daysInPreviousMonth - i
            selected = (
              this.props.day == day && this.props.month == previousMonth && this.props.year == previousYear
            )
            days.unshift(
              <DayLabel
                day={day}
                month={previousMonth}
                year={previousYear}
                selected={selected}
                otherMonth={true}
                setSelectedDate={this.props.setSelectedDate}
                key={100 + i}
              />
            )
          }

          for (var i=1; i<daysInMonth(this.props.viewMonth, this.props.viewYear) + 1; i++){
            days.push(
              <DayLabel
                day={i}
                month={this.props.viewMonth}
                year={this.props.viewYear}
                selected={this.props.day == i && this.props.month == this.props.viewMonth && this.props.year == this.props.viewYear}
                setSelectedDate={this.props.setSelectedDate}
                key={i}
              />
            )
          }

          for (var i=1; i<7 - lastDayOfMonth.getDay(); i++){
            day = i
            selected = (
              this.props.day == day && this.props.month == nextMonth && this.props.year == nextYear
            )
            days.push(
              <DayLabel
                day={day}
                month={nextMonth}
                year={nextYear}
                selected={selected}
                otherMonth={true}
                setSelectedDate={this.props.setSelectedDate}
                key={1000 + i}
              />
            )
          }

          var dayNames = range(7).map(function(i){
            return (
              <div className="cell dayCell daysCellHeader">
                {dayNamesShort[i]}
              </div>
            )
          });

          var dayRows = range(days.length / 7).map(function(i){
            return (
              <div className="daysSelectorTableRow">
                {days.slice(i * 7, (i + 1) * 7)}
              </div>
            )
          });

          return (
            <div>
              <MonthSwitcher
                viewMonth={this.props.viewMonth}
                viewYear={this.props.viewYear}
                setViewMonth={this.props.setViewMonth}
                setViewYear={this.props.setViewYear}
                setSelectedView={this.props.setSelectedView}
              />
              <div className="daysTable">
                <div className="daysSelectorTableHeader">
                  {dayNames}
                </div>
                {dayRows}
              </div>
            </div>
          );
        }
      });

      var MonthLabel = React.createClass({
        setViewMonth: function() {
          this.props.setViewMonth(this.props.month);
          this.props.setViewYear(this.props.switcherYear);
          this.props.setSelectedView("day");
        },

        render: function() {
          var className = "dayCell";
          if (this.props.selected) className += " dayCellSelected"
          return (
            <div className="cell">
              <div onClick={this.setViewMonth} className={className}>{monthNamesShort[this.props.month]}</div>
            </div>
          )
        }
      })

      var YearSwitcher = React.createClass({
        switchToPreviousYear: function() {
          this.props.setSwitcherYear(this.props.switcherYear - 1);
        },

        switchToNextYear: function() {
          this.props.setSwitcherYear(this.props.switcherYear + 1);
        },

        handleYearClick: function(){
          this.props.setSelectedView("year");
        },

        render: function() {
          return (
            <div className="switcherContainer">
              <div onClick={this.switchToPreviousYear} className="leftArrow"> &larr; </div>
              <div onClick={this.switchToNextYear} className="rightArrow"> &rarr; </div>
              <div className="switcherCentralContainer" onClick={this.handleYearClick}>
                <span className="switcherButton">
                  {this.props.switcherYear}
                </span>
              </div>
            </div>
          )
        }
      });

      var ViewMonthSelector = React.createClass({
        getInitialState: function() {
          return {
            "switcherYear": this.props.viewYear
          };
        },

        setSwitcherYear: function(switcherYear){
          this.setState({"switcherYear": switcherYear})
        },

        render: function() {
          var months = []
          for (var i=0; i<monthNamesShort.length; i++){
            months.push(
              <MonthLabel
                month={i}
                key={i}
                selected={i==this.props.month && this.state.switcherYear==this.props.selectedYear}
                switcherYear={this.state.switcherYear}
                setViewMonth={this.props.setViewMonth}
                setViewYear={this.props.setViewYear}
                setSelectedView={this.props.setSelectedView}
              />
            );
          }

          var monthRows = range(4).map(function(i){
            return (
              <div className="daysSelectorTableRow">
                {months.slice(i * 3, (i + 1) * 3)}
              </div>
            )
          });

          return (
            <div>
              <YearSwitcher
                switcherYear={this.state.switcherYear}
                setSwitcherYear={this.setSwitcherYear}
                setSelectedView={this.props.setSelectedView} 
              />
              <div className="daysTable">
                {monthRows}
              </div>
            </div>
          );
        }
      });

      var YearLabel = React.createClass({
        setViewYear: function() {
          this.props.setViewYear(this.props.year);
          this.props.setSelectedView("month");
        },

        render: function() {
          var className = "dayCell";
          if (this.props.selected) className += " dayCellSelected"
          return (
            <div className="cell">
              <div onClick={this.setViewYear} className={className}>{this.props.year}</div>
            </div>
          )
        }
      })

      var YearRangeSwitcher = React.createClass({
        switchToPreviousRange: function() {
          this.props.setStartYear(this.props.startYear - this.props.yearsOnPage);
        },

        switchToNextRange: function() {
          this.props.setStartYear(this.props.startYear + this.props.yearsOnPage);
        },

        render: function() {
          return (
            <div className="switcherContainer">
              <div onClick={this.switchToPreviousRange} className="leftArrow"> &larr; </div>
              <div onClick={this.switchToNextRange} className="rightArrow"> &rarr; </div>
              <div className="switcherCentralContainer">
                <span className="switcherLabel">
                  {this.props.startYear} - {this.props.startYear + this.props.yearsOnPage - 1}
                </span>
              </div>
            </div>
          )
        }
      });

      var ViewYearSelector = React.createClass({
        getInitialState: function() {
          var yearsInRow = 4;
          var yearsInColumn = 5;
          var yearsOnPage = yearsInRow * yearsInColumn;
          var startYear = Math.floor(this.props.year / yearsOnPage) * yearsOnPage;
          return {
            "yearsInRow": yearsInRow,
            "yearsInColumn": yearsInColumn,
            "yearsOnPage": yearsOnPage,
            "startYear": startYear
          };
        },

        setStartYear: function(startYear){
          this.setState({"startYear": startYear})
        },

        render: function() {
          var years = []
          for (var i=this.state.startYear; i < this.state.startYear + this.state.yearsOnPage; i++){
            years.push(
              <YearLabel
                year={i}
                key={i}
                selected={i==this.props.year}
                setViewYear={this.props.setViewYear}
                setSelectedView={this.props.setSelectedView}
              />
            )
          };

          var yearRows = [];
          for (var i=0; i<this.state.yearsInColumn; i++){
            yearRows.push(
              <div className="daysSelectorTableRow">
                {years.slice(i * this.state.yearsInRow, (i + 1) * this.state.yearsInRow)}
              </div>
            )
          }

          return (
            <div>
              <YearRangeSwitcher
                startYear={this.state.startYear}
                yearsOnPage={this.state.yearsOnPage}
                setStartYear={this.setStartYear}
              />
              <div className="daysTable">
                {yearRows}
              </div>
            </div>
          );
        }
      });

      ReactDOM.render(
        <DateSelector />,
        document.getElementById('content')
      );
    </script>
  </body>
</html>
